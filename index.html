<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Shipping Label Generator</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <!-- jsPDF Custom Font -->
  <script src="https://raw.githubusercontent.com/nasimulhasan/testlabel/main/MangoDream-normal.js
" type="text/javascript"></script>
  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <!-- JSZip -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js"></script>
  <!-- FileSaver -->
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    body { padding-top: 2rem; background: #f8f9fa; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container d-flex justify-content-center">
    <div class="w-100" style="max-width: 600px;">
      <div class="card shadow-sm mb-4">
        <div class="card-body p-4">
          <h1 class="card-title text-center mb-4">Custom Label Generator</h1>

          <!-- Instructions Button -->
          <button type="button" class="btn btn-secondary mb-4 w-100" data-bs-toggle="modal" data-bs-target="#instructionsModal">
            Instructions
          </button>

          <!-- Instructions Modal -->
          <div class="modal fade" id="instructionsModal" tabindex="-1" aria-labelledby="instructionsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="instructionsModalLabel">ব্যবহার নির্দেশনা</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <ol class="ps-3">
                    <li class="mb-3">
                      <strong>PDF সাইজ:</strong>
                      <ul class="ps-3 mb-0">
                        <li>
                          ডিফল্ট:
                          <code class="text-primary">152.4&nbsp;mm × 101.6&nbsp;mm</code>
                          (<span class="text-secondary">6″ × 4″</span>)
                        </li>
                      </ul>
                    </li>
                    <li class="mb-3">
                      <strong>ইমেজ সাইজ:</strong>
                      <ul class="ps-3 mb-0">
                        <li>হেডার: <code class="text-primary">≥900×300px</code> (JPEG/PNG)</li>
                        <li>ফুটার: <code class="text-primary">≥900×450px</code> (JPEG/PNG)</li>
                        <li class="text-warning">
                          <strong>মহত্বপূর্ণ:</strong>
                          হেডার এবং ফুটার স্বয়ংক্রিয়ভাবে লেবেলের পূর্ণ প্রস্থে প্রসারিত হবে। নিশ্চিত করুন যে
                          <code class="text-primary">paper size</code> অনুযায়ী ছবিগুলো পর্যাপ্ত প্রস্থের এবং সঠিক অনুপাতের।
                        </li>
                      </ul>
                    </li>
                    <li class="mb-3">
                      <strong>এক্সেল:</strong>
                      <ul class="ps-3 mb-0">
                        <li>এক্সটেনশন: <code class="text-primary">.xls</code>, <code class="text-primary">.xlsx</code> &mdash;
                          <a href="EXCEL_TEMPLATE_URL" class="text-decoration-underline" target="_blank">ডাউনলোড এক্সেল টেমপ্লেট</a>
                        </li>
                        <li>কলাম: <code class="text-primary">Invoice</code>, <code class="text-primary">First Name</code>, <code class="text-primary">Last Name</code>, <code class="text-primary">Phone</code>, <code class="text-primary">Address</code>, <code class="text-primary">Order Total Amount</code></li>
                      </ul>
                    </li>
                    <li class="mb-3">
                      <strong>ফোন:</strong>
                      <ul class="ps-3 mb-0">
                        <li>শুধুমাত্র ১১ সংখ্যার <code class="text-primary">0xxxxxxxxxx</code> ফরম্যাট</li>
                      </ul>
                    </li>
                    <li class="mb-3">
                      <strong>ইনভয়েস সিলেকশন:</strong>
                      <ul class="ps-3 mb-0">
                        <li>Ctrl (Windows) / Cmd (Mac) দিয়ে একাধিক নির্বাচন</li>
                      </ul>
                    </li>
                    <li class="mb-3">
                      <strong>ডাউনলোড:</strong>
                      <ul class="ps-3 mb-0">
                        <li><code class="text-primary">shipping_labels.zip</code></li>
                      </ul>
                    </li>
                  </ol>
                  <p class="text-info">
                    <strong>ভিডিও নির্দেশিকা:</strong>
                    <a href="YOUTUBE_URL" class="text-decoration-underline" target="_blank" rel="noopener noreferrer">টিউটোরিয়াল দেখুন</a>
                  </p>
                  <p class="text-info">
                    <strong>পরামর্শ:</strong>
                    যদি হেডার/ফুটার বিকৃত হয়, <code class="text-primary">Custom</code> paper size নির্বাচন করে
                    প্রস্থ ও উচ্চতা (mm/in) সমন্বয় করুন।
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Paper size hybrid UI -->
          <div class="mb-3 row">
            <label for="presetSize" class="col-sm-4 col-form-label">Paper Size</label>
            <div class="col-sm-8">
              <select id="presetSize" class="form-select">
                <option value="152.4,101.6,mm">4×6 in (152.4×101.6 mm)</option>
                <option value="101.6,152.4,mm">6×4 in (101.6×152.4 mm)</option>
                <option value="210,297,mm">A4 (210×297 mm)</option>
                <option value="216,279,mm">Letter (216×279 mm)</option>
                <option value="custom">Custom</option>
              </select>
            </div>
          </div>
          <div id="customSizeFields" class="mb-3 row d-none">
            <div class="col-sm-4">
              <label for="paperWidth" class="form-label">Width</label>
              <input type="number" id="paperWidth" class="form-control" placeholder="Width">
            </div>
            <div class="col-sm-4">
              <label for="paperHeight" class="form-label">Height</label>
              <input type="number" id="paperHeight" class="form-control" placeholder="Height">
            </div>
            <div class="col-sm-4">
              <label for="paperUnit" class="form-label">Unit</label>
              <select id="paperUnit" class="form-select">
                <option value="mm" selected>mm</option>
                <option value="in">in</option>
                <option value="pt">pt</option>
              </select>
            </div>
          </div>

          <!-- Form and remaining code unchanged for brevity -->
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const { jsPDF } = window.jspdf;
    let parsedRows = [], invoiceList = [];

    // Toggle custom size fields
    document.getElementById('presetSize').addEventListener('change', e => {
      document.getElementById('customSizeFields').classList.toggle('d-none', e.target.value !== 'custom');
    });

    const alertPlaceholder = document.getElementById('alertPlaceholder');
    function showAlert(msg, type='danger') { const wrap=document.createElement('div'); wrap.innerHTML=`<div class="alert alert-${type} alert-dismissible" role="alert">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`; alertPlaceholder.append(wrap); }

    document.getElementById('excelInput').addEventListener('change', async (e) => {
      const file = e.target.files[0]; if(!file) return;
      try {
        const buff = await readFileAsArrayBuffer(file);
        const wb = XLSX.read(buff, { type: 'array' });
        let last = {};
        parsedRows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: '' })
          .map(r => { ['Invoice','First Name','Last Name','Phone','Address','Order Total Amount'].forEach(k => r[k] = r[k] || last[k] || ''); last = { ...r }; return r; });
        invoiceList = [...new Set(parsedRows.map(r => String(r['Invoice']).trim()))].sort();
        const sel = document.getElementById('invoiceSelect'); sel.innerHTML = '';
        invoiceList.forEach(inv => sel.append(new Option(inv, inv)));
        document.getElementById('invoiceSelection').classList.remove('hidden');
      } catch(err) { showAlert('Error parsing Excel: ' + err.message); }
    });

    document.getElementById('generateBtn').addEventListener('click', async () => {
      alertPlaceholder.innerHTML = '';
      const headerFile = document.getElementById('headerInput').files[0];
      const footerFile = document.getElementById('footerInput').files[0];
      if (!headerFile || !footerFile) return showAlert('Select both header and footer.');
      if (!parsedRows.length) return showAlert('Upload and parse Excel first.');

      // Paper size calculation
      let [w, h, unit] = document.getElementById('presetSize').value.split(',');
      if (w === 'custom') {
        w = parseFloat(document.getElementById('paperWidth').value);
        h = parseFloat(document.getElementById('paperHeight').value);
        unit = document.getElementById('paperUnit').value;
        if (unit === 'in') { w *= 25.4; h *= 25.4; unit = 'mm'; }
        if (unit === 'pt') { w *= 0.352778; h *= 0.352778; unit = 'mm'; }
      } else { w = +w; h = +h; }

      const headerUrl = await readFileAsDataURL(headerFile);
      const footerUrl = await readFileAsDataURL(footerFile);
      const zip = new JSZip();

      const selectedOpts = Array.from(document.getElementById('invoiceSelect').selectedOptions).map(o => o.value);
      const targets = selectedOpts.length ? selectedOpts : invoiceList;

      for (const inv of targets) {
        const group = parsedRows.filter(r => String(r['Invoice']).trim() === inv);
        if (!group.length) continue;

        const doc = new jsPDF({ unit, format: [w, h] });
        doc.addFont('MangoDream-normal.ttf', 'MangoDream', 'normal');
        doc.setFont('MangoDream', 'normal');
        doc.setFontSize(10);

        // Header & footer images
        doc.addImage(headerUrl, 'PNG', 0, 0, w, w * (30 / 101.6));
        doc.addImage(footerUrl, 'PNG', 0, h - (49 * (h / 101.6)), w, h * (49 / 101.6));

        let y = (30 * (h / 101.6)) + 11;
        const leftMargin = 10;

        doc.text(`Invoice #: ${inv}`, leftMargin, y); y += 7;
        const name = titleCase(group[0]['First Name'] + ' ' + group[0]['Last Name']);
        doc.text(`Name: ${name}`, leftMargin, y); y += 7;

        let raw = String(group[0]['Phone']).replace(/\D/g, '');
        if (raw.startsWith('880')) raw = raw.slice(3);
        else if (raw.startsWith('0')) raw = raw.slice(1);
        if (raw.length > 10) raw = raw.slice(-10);
        doc.text(`Phone: 0${raw}`, leftMargin, y); y += 7;

        const fullAddr = `Address: ${titleCase(group[0]['Address'])}`;
        const addrLines = doc.splitTextToSize(fullAddr, w - (leftMargin * 2));
        doc.text(addrLines, leftMargin, y); y += addrLines.length * 7;

        const notes = group.map(r => r['NOTE'] || '').join(' ').toLowerCase();
        const total = notes.includes('paid') ? '0' : String(Math.round(group[0]['Order Total Amount']));
        doc.text(`Total: Tk ${total}`, leftMargin, y); y += 7;

        doc.text('Items:', leftMargin, y); y += 7;
        group.forEach(r => {
          const item = r['Items'] ? titleCase(r['Items']) : '';
          const qty = r['Quantity'] ? ` (${r['Quantity']})` : '';
          if (item) {
            doc.text(`- ${item}${qty}`, leftMargin, y);
            y += 7;
          }
        });

        zip.file(`${inv}.pdf`, doc.output('blob'));
      }

      const zipBlob = await zip.generateAsync({ type: 'blob' });
      saveAs(zipBlob, 'shipping_labels.zip');
    });

    // Helpers
    function readFileAsDataURL(file) {
      return new Promise(res => {
        const reader = new FileReader();
        reader.onload = () => res(reader.result);
        reader.readAsDataURL(file);
      });
    }
    function readFileAsArrayBuffer(file) {
      return new Promise(res => {
        const reader = new FileReader();
        reader.onload = () => res(reader.result);
        reader.readAsArrayBuffer(file);
      });
    }
    function titleCase(str) {
      return String(str)
        .toLowerCase()
        .split(' ')
        .map(w => w.charAt(0).toUpperCase() + w.slice(1))
        .join(' ');
    }
  </script>
</body>
</html>
