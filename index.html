<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Shipping Label Generator</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <!-- JSZip -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js"></script>
  <!-- FileSaver -->
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    body { padding-top: 2rem; background: #f8f9fa; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container d-flex justify-content-center">
    <div class="w-100" style="max-width: 600px;">
      <div class="card shadow-sm mb-4">
        <div class="card-body p-4">
          <h1 class="card-title text-center mb-4">Custom Label Generator</h1>

          <!-- Instructions Button (unchanged) -->
          <button type="button" class="btn btn-secondary mb-4 w-100" data-bs-toggle="modal" data-bs-target="#instructionsModal">
            Instructions
          </button>
          <!-- ... your instructions modal here ... -->

          <!-- Paper size controls (unchanged) -->
          <div class="mb-3 row">
            <label for="presetSize" class="col-sm-4 col-form-label">Paper Size</label>
            <div class="col-sm-8">
              <select id="presetSize" class="form-select">
                <option value="152.4,101.6,mm">4×6 in (152.4×101.6 mm)</option>
                <option value="101.6,152.4,mm">6×4 in (101.6×152.4 mm)</option>
                <option value="210,297,mm">A4 (210×297 mm)</option>
                <option value="216,279,mm">Letter (216×279 mm)</option>
                <option value="custom">Custom</option>
              </select>
            </div>
          </div>
          <div id="customSizeFields" class="mb-3 row d-none">
            <!-- custom size inputs unchanged -->
          </div>

          <!-- Form Inputs -->
          <form id="labelForm">
            <!-- NEW: Font upload -->
            <div class="mb-2">
              <label for="fontInput" class="form-label">Upload Font (TTF/OTF)</label>
              <input type="file" id="fontInput" class="form-control" accept=".ttf,.otf">
            </div>

            <!-- existing inputs -->
            <div class="mb-2">
              <label for="headerInput" class="form-label">Header Image</label>
              <input type="file" class="form-control" id="headerInput" accept="image/*">
            </div>
            <div class="mb-2">
              <label for="footerInput" class="form-label">Footer Image</label>
              <input type="file" class="form-control" id="footerInput" accept="image/*">
            </div>
            <div class="mb-2">
              <label for="excelInput" class="form-label">Excel File</label>
              <input type="file" class="form-control" id="excelInput" accept=".xls,.xlsx">
            </div>
            <div id="invoiceSelection" class="mb-2 hidden">
              <label for="invoiceSelect" class="form-label">Select Invoices (optional)</label>
              <select id="invoiceSelect" class="form-select" multiple size="8"></select>
              <div class="form-text">Hold Ctrl (Windows) / Cmd (Mac) to select multiple.</div>
            </div>
            <button type="button" id="generateBtn" class="btn btn-primary w-100">Generate Labels</button>
          </form>
          <div id="alertPlaceholder" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const { jsPDF } = window.jspdf;
    let parsedRows = [], invoiceList = [];

    // store uploaded font
    let customFontName = null;
    let customFontData = null;

    // read helpers
    function readFileAsDataURL(file) {
      return new Promise(res => {
        const rd = new FileReader();
        rd.onload = () => res(rd.result);
        rd.readAsDataURL(file);
      });
    }
    function readFileAsArrayBuffer(file) {
      return new Promise(res => {
        const rd = new FileReader();
        rd.onload = () => res(rd.result);
        rd.readAsArrayBuffer(file);
      });
    }
    function titleCase(s) {
      return s.toLowerCase().split(' ')
        .map(w => w[0].toUpperCase() + w.slice(1))
        .join(' ');
    }

    // Toggle custom-size fields
    document.getElementById('presetSize').addEventListener('change', e => {
      document.getElementById('customSizeFields')
        .classList.toggle('d-none', e.target.value !== 'custom');
    });

    const alertPlaceholder = document.getElementById('alertPlaceholder');
    function showAlert(msg, type='danger') {
      const div = document.createElement('div');
      div.innerHTML = `<div class="alert alert-${type} alert-dismissible" role="alert">
                         ${msg}
                         <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                       </div>`;
      alertPlaceholder.append(div);
    }

    // handle font upload
    document.getElementById('fontInput').addEventListener('change', async e => {
      const file = e.target.files[0];
      if (!file) return;
      const dataUrl = await readFileAsDataURL(file);
      customFontName = file.name;                     // e.g. "MyFont.ttf"
      customFontData = dataUrl.split(',')[1];         // base64 payload
      console.log('Loaded font:', customFontName);
    });

    // parse Excel (unchanged)
    document.getElementById('excelInput').addEventListener('change', async (e) => {
      const file = e.target.files[0]; if (!file) return;
      try {
        const buff = await readFileAsArrayBuffer(file);
        const wb = XLSX.read(buff, { type: 'array' });
        let last = {};
        parsedRows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: '' })
          .map(r => {
            ['Invoice','First Name','Last Name','Phone','Address','Order Total Amount']
              .forEach(k => r[k] = r[k] || last[k] || '');
            last = {...r};
            return r;
          });
        invoiceList = [...new Set(parsedRows.map(r => String(r['Invoice']).trim()))].sort();
        const sel = document.getElementById('invoiceSelect');
        sel.innerHTML = '';
        invoiceList.forEach(i=> sel.append(new Option(i,i)));
        document.getElementById('invoiceSelection').classList.remove('hidden');
      } catch(err) {
        showAlert('Error parsing Excel: ' + err.message);
      }
    });

    // generate labels
    document.getElementById('generateBtn').addEventListener('click', async () => {
      alertPlaceholder.innerHTML = '';
      const header = document.getElementById('headerInput').files[0];
      const footer = document.getElementById('footerInput').files[0];
      if (!header || !footer) return showAlert('Select both header and footer.');
      if (!parsedRows.length)   return showAlert('Upload and parse Excel first.');

      // paper size logic (unchanged)…
      let unit, w, h;
      const preset = document.getElementById('presetSize').value;
      if (preset==='custom') {
        w = +document.getElementById('paperWidth').value;
        h = +document.getElementById('paperHeight').value;
        unit = document.getElementById('paperUnit').value;
        if (unit==='in'){ w*=25.4; h*=25.4; unit='mm'; }
        if (unit==='pt'){ w*=0.352778; h*=0.352778; unit='mm'; }
      } else {
        [w,h,unit] = preset.split(','); w=+w; h=+h;
      }

      const headerUrl = await readFileAsDataURL(header);
      const footerUrl = await readFileAsDataURL(footer);
      const zip = new JSZip();
      const opts = Array.from(document.getElementById('invoiceSelect')
                         .selectedOptions).map(o=>o.value);
      const targets = opts.length ? opts : invoiceList;

      for (const inv of targets) {
        const group = parsedRows.filter(r=>String(r['Invoice']).trim()===inv);
        if (!group.length) continue;

        const doc = new jsPDF({ unit, format:[w,h] });
        doc.setFontSize(10);

        // ── inject uploaded font if available ──────────────────────────
        if (customFontName && customFontData) {
          doc.addFileToVFS(customFontName, customFontData);
          doc.addFont(customFontName, 'CustomFont', 'normal');
          doc.setFont('CustomFont', 'normal');
        }
        // ───────────────────────────────────────────────────────────────

        doc.addImage(headerUrl,'PNG',0,0,w, w*(30/101.6));
        doc.addImage(footerUrl,'PNG',0,h-(49*h/101.6),w, h*(49/101.6));

        let y = w*(30/101.6) + 11, left = 10;
        doc.text(`Invoice #: ${inv}`, left, y); y+=7;
        const name = titleCase(group[0]['First Name']+' '+group[0]['Last Name']);
        doc.text(`Name: ${name}`, left, y); y+=7;

        let num = String(group[0]['Phone']).replace(/\D/g,'');
        if(num.startsWith('880')) num=num.slice(3);
        else if(num.startsWith('0')) num=num.slice(1);
        if(num.length>10) num=num.slice(-10);
        doc.text(`Phone: 0${num}`, left, y); y+=7;

        const addr = `Address: ${titleCase(group[0]['Address'])}`;
        const lines = doc.splitTextToSize(addr, w-left*2);
        doc.text(lines, left, y); y += lines.length*7;

        const notes = group.map(r=>r['NOTE']||'').join(' ').toLowerCase();
        const total = notes.includes('paid') ? '0' : String(Math.round(group[0]['Order Total Amount']));
        doc.text(`Total: Tk ${total}`, left, y); y+=7;

        doc.text('Items:', left, y); y+=7;
        group.forEach(r => {
          const item = r['Items'] ? titleCase(r['Items']) : '';
          const qty  = r['Quantity'] ? ` (${r['Quantity']})` : '';
          if(item) { doc.text(`- ${item}${qty}`, left, y); y+=7; }
        });

        zip.file(`${inv}.pdf`, doc.output('blob'));
      }

      const blob = await zip.generateAsync({type:'blob'});
      saveAs(blob, 'shipping_labels.zip');
    });
  </script>
</body>
</html>
