<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Shipping Label Generator</title>
  <style>
    body { padding-top: 2rem; background: #f8f9fa; }
    .hidden { display: none; }
  </style>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- SheetJS for Excel parsing -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <!-- jsPDF UMD bundle -->
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <!-- jsPDF Custom Font (raw) -->
  <script defer src="https://raw.githubusercontent.com/nasimulhasan/testlabel/main/MangoDream-normal.js"></script>
  <!-- JSZip -->
  <script defer src="https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js"></script>
  <!-- FileSaver -->
  <script defer src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <!-- Bootstrap JS Bundle -->
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
  <div class="container d-flex justify-content-center">
    <div class="w-100" style="max-width: 600px;">
      <div class="card shadow-sm mb-4">
        <div class="card-body p-4">
          <h1 class="card-title text-center mb-4">Custom Label Generator</h1>

          <!-- Instructions Button -->
          <button type="button" class="btn btn-secondary mb-4 w-100" data-bs-toggle="modal" data-bs-target="#instructionsModal">
            Instructions
          </button>

          <!-- Instructions Modal -->
          <div class="modal fade" id="instructionsModal" tabindex="-1" aria-labelledby="instructionsModalLabel" aria-hidden="true">
            <!-- ... your modal content unchanged ... -->
          </div>

          <!-- Paper size hybrid UI -->
          <div class="mb-3 row">
            <label for="presetSize" class="col-sm-4 col-form-label">Paper Size</label>
            <div class="col-sm-8">
              <select id="presetSize" class="form-select">
                <option value="152.4,101.6,mm">4Ã—6 in (152.4Ã—101.6 mm)</option>
                <option value="101.6,152.4,mm">6Ã—4 in (101.6Ã—152.4 mm)</option>
                <option value="210,297,mm">A4 (210Ã—297 mm)</option>
                <option value="216,279,mm">Letter (216Ã—279 mm)</option>
                <option value="custom">Custom</option>
              </select>
            </div>
          </div>
          <div id="customSizeFields" class="mb-3 row d-none">
            <!-- ... custom size inputs unchanged ... -->
          </div>

          <!-- Form Inputs -->
          <form id="labelForm">
            <!-- ... header, footer, excel inputs ... -->
            <div id="invoiceSelection" class="mb-2 hidden">
              <!-- ... invoice select ... -->
            </div>
            <button type="button" id="generateBtn" class="btn btn-primary w-100">
              Generate Labels
            </button>
          </form>
          <div id="alertPlaceholder" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM loaded, initializing appâ€¦');

    // Toggle custom-size fields
    const preset = document.getElementById('presetSize');
    const customFields = document.getElementById('customSizeFields');
    preset.addEventListener('change', e => {
      customFields.classList.toggle('d-none', e.target.value !== 'custom');
    });

    // Grab jsPDF safely
    const jspdfGlobal = window.jspdf
      || (window.jsPDF && { jsPDF: window.jsPDF });
    if (!jspdfGlobal) {
      console.error('ðŸš¨ jsPDF did not load!');
      alert('Library error: jsPDF failed to load.');
      return;
    }
    const { jsPDF } = jspdfGlobal;

    let parsedRows = [], invoiceList = [];
    const alertPlaceholder = document.getElementById('alertPlaceholder');

    function showAlert(msg, type = 'danger') {
      const wrap = document.createElement('div');
      wrap.innerHTML = 
        `<div class="alert alert-${type} alert-dismissible" role="alert">
           ${msg}
           <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
         </div>`;
      alertPlaceholder.append(wrap);
    }

    // Excel parsing
    document.getElementById('excelInput').addEventListener('change', async e => {
      // ... your existing excel parsing code unchanged ...
    });

    // Generate PDFs
    document.getElementById('generateBtn').addEventListener('click', async () => {
      console.log('ðŸ‘‰ Generate Labels clicked');
      alertPlaceholder.innerHTML = '';

      // Basic validations
      const headerFile = document.getElementById('headerInput').files[0];
      const footerFile = document.getElementById('footerInput').files[0];
      if (!headerFile || !footerFile) {
        return showAlert('Select both header and footer.');
      }
      if (!parsedRows.length) {
        return showAlert('Upload and parse Excel first.');
      }

      // Paper size logic (unchanged) â€¦
      let [w, h, unit] = document.getElementById('presetSize').value.split(',');
      if (w === 'custom') {
        w = parseFloat(document.getElementById('paperWidth').value);
        h = parseFloat(document.getElementById('paperHeight').value);
        unit = document.getElementById('paperUnit').value;
        if (unit === 'in') { w *= 25.4; h *= 25.4; unit = 'mm'; }
        if (unit === 'pt') { w *= 0.352778; h *= 0.352778; unit = 'mm'; }
      } else { w = +w; h = +h; }

      const headerUrl = await readFileAsDataURL(headerFile);
      const footerUrl = await readFileAsDataURL(footerFile);
      const zip = new JSZip();

      const opts = Array.from(document.getElementById('invoiceSelect')
                              .selectedOptions).map(o => o.value);
      const targets = opts.length ? opts : invoiceList;

      for (const inv of targets) {
        const group = parsedRows.filter(r => String(r['Invoice']).trim() === inv);
        if (!group.length) continue;

        const doc = new jsPDF({ unit, format: [w, h] });
        // try loading your custom font without killing the script
        try {
          doc.addFont('MangoDream-normal.ttf', 'MangoDream', 'normal');
          doc.setFont('MangoDream', 'normal');
        } catch (fontErr) {
          console.warn('âš ï¸ Custom font load failed:', fontErr);
        }
        doc.setFontSize(10);

        // Header & footer images
        doc.addImage(headerUrl, 'PNG', 0, 0, w, w * (30 / 101.6));
        doc.addImage(footerUrl, 'PNG', 0, h - (49 * (h / 101.6)), w, h * (49 / 101.6));

        // â€¦ rest of your PDF text logic unchanged â€¦

        zip.file(`${inv}.pdf`, doc.output('blob'));
      }

      const blob = await zip.generateAsync({ type: 'blob' });
      saveAs(blob, 'shipping_labels.zip');
    });

    // FileReader helpers (unchanged) â€¦
    function readFileAsDataURL(file) {
      return new Promise(res => {
        const reader = new FileReader();
        reader.onload = () => res(reader.result);
        reader.readAsDataURL(file);
      });
    }
    function readFileAsArrayBuffer(file) {
      return new Promise(res => {
        const reader = new FileReader();
        reader.onload = () => res(reader.result);
        reader.readAsArrayBuffer(file);
      });
    }
    function titleCase(str) {
      return String(str).toLowerCase()
        .split(' ')
        .map(w => w.charAt(0).toUpperCase() + w.slice(1))
        .join(' ');
    }
  });
  </script>
</body>
</html>
